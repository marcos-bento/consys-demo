// prisma/schema.prisma

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =========================
// CADASTROS - PRODUTOS / ESTOQUE
// =========================

model ProductCategory {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]
}

model Product {
  id                String   @id @default(uuid()) @db.Uuid
  sku               String   @unique
  name              String
  description       String?
  categoryId        String?  @db.Uuid
  unit              String
  isStockControlled Boolean  @default(true)
  minStock          Int?
  active            Boolean  @default(true)
  baseCost          Decimal  @default(0) @db.Decimal(12, 2)
  basePrice         Decimal  @default(0) @db.Decimal(12, 2)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  category       ProductCategory? @relation(fields: [categoryId], references: [id])
  stockBalance   StockBalance?
  stockMovements StockMovement[]
  documentItems  DocumentItem[]
  purchaseItems  PurchaseItem[]
}

model StockBalance {
  id        String   @id @default(uuid()) @db.Uuid
  productId String   @unique @db.Uuid
  quantity  Int      @default(0)
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id])
}

model StockMovement {
  id            String   @id @default(uuid()) @db.Uuid
  productId     String   @db.Uuid
  type          String   // IN | OUT | ADJUST
  quantity      Int
  note          String?
  referenceType String?  // DOCUMENT | PURCHASE | ASSIST | MANUAL
  referenceId   String?  @db.Uuid
  createdAt     DateTime @default(now())

  product Product @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([referenceId])
}


// =========================
// CADASTROS - CLIENTES
// =========================

model Client {
  id        String   @id @default(uuid()) @db.Uuid
  type      String   // PJ | PF
  name      String
  tradeName String?
  document  String
  email     String?
  phone     String?
  status    String   @default("ACTIVE") // ACTIVE | INACTIVE
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  addresses        ClientAddress[]
  deals            Deal[]
  documents        Document[]
  financialEntries FinancialEntry[]
  assistances      Assistance[]
  vehicleSchedules VehicleSchedule[]
  serviceOrderItems ServiceOrderItem[]
}

model ClientAddress {
  id         String   @id @default(uuid()) @db.Uuid
  clientId   String   @db.Uuid
  label      String   // Principal, Cobrança, Entrega
  street     String
  number     String?
  complement String?
  district   String?
  city       String
  state      String
  zipCode    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  client          Client            @relation(fields: [clientId], references: [id])
  assistances     Assistance[]
  vehicleSchedules VehicleSchedule[]
  serviceOrderItems ServiceOrderItem[]

  @@index([clientId])
}


// =========================
// CADASTROS - FORNECEDORES
// =========================

model SupplierCategory {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  suppliers Supplier[]
}

model Supplier {
  id         String   @id @default(uuid()) @db.Uuid
  name       String
  tradeName  String?
  document   String
  categoryId String?  @db.Uuid
  email      String?
  phone      String?
  status     String   @default("ACTIVE") // ACTIVE | INACTIVE
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  category        SupplierCategory? @relation(fields: [categoryId], references: [id])
  addresses       SupplierAddress[]
  contacts        SupplierContact[]
  purchases       Purchase[]
  documents       Document[]
  financialEntries FinancialEntry[]

  @@index([categoryId])
}

model SupplierAddress {
  id         String   @id @default(uuid()) @db.Uuid
  supplierId String   @db.Uuid
  label      String
  street     String
  number     String?
  complement String?
  district   String?
  city       String
  state      String
  zipCode    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  supplier Supplier @relation(fields: [supplierId], references: [id])

  @@index([supplierId])
}

model SupplierContact {
  id         String   @id @default(uuid()) @db.Uuid
  supplierId String   @db.Uuid
  name       String
  role       String?
  email      String?
  phone      String?
  notes      String?
  createdAt  DateTime @default(now())

  supplier Supplier @relation(fields: [supplierId], references: [id])

  @@index([supplierId])
}


// =========================
// DOCUMENTOS
// =========================

model DocumentType {
  id     String  @id @default(uuid()) @db.Uuid
  name   String  @unique
  active Boolean @default(true)

  documents Document[]
}

model DocumentStatus {
  id     String  @id @default(uuid()) @db.Uuid
  name   String  @unique // DRAFT, ISSUED, SENT, SIGNED, CANCELED
  active Boolean @default(true)

  documents Document[]
}

model Document {
  id         String   @id @default(uuid()) @db.Uuid
  code       String   @unique
  typeId     String   @db.Uuid
  statusId   String   @db.Uuid

  clientId   String?  @db.Uuid
  supplierId String?  @db.Uuid

  title       String?
  description String?
  total       Decimal  @default(0) @db.Decimal(12, 2)
  discount    Decimal  @default(0) @db.Decimal(12, 2)

  createdById String?  @db.Uuid
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  type      DocumentType   @relation(fields: [typeId], references: [id])
  status    DocumentStatus @relation(fields: [statusId], references: [id])
  client    Client?        @relation(fields: [clientId], references: [id])
  supplier  Supplier?      @relation(fields: [supplierId], references: [id])
  createdBy User?          @relation(fields: [createdById], references: [id])

  items     DocumentItem[]
  files     DocumentFile[]
  events    DocumentEvent[]

  dealLinks       DealDocument[]
  financialEntries FinancialEntry[]
  assistanceLinks AssistanceDocument[]

  @@index([clientId])
  @@index([supplierId])
  @@index([createdById])
  @@index([typeId])
  @@index([statusId])
}

model DocumentItem {
  id          String   @id @default(uuid()) @db.Uuid
  documentId  String   @db.Uuid
  productId   String?  @db.Uuid
  description String?
  quantity    Decimal  @default(1) @db.Decimal(12, 2)
  unitPrice   Decimal  @default(0) @db.Decimal(12, 2)
  total       Decimal  @default(0) @db.Decimal(12, 2)
  createdAt   DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id])
  product  Product? @relation(fields: [productId], references: [id])

  @@index([documentId])
  @@index([productId])
}

model DocumentFile {
  id         String   @id @default(uuid()) @db.Uuid
  documentId String   @db.Uuid
  fileName   String
  mimeType   String?
  storageKey String
  sizeBytes  Int?
  createdAt  DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id])

  @@index([documentId])
}

model DocumentEvent {
  id          String   @id @default(uuid()) @db.Uuid
  documentId  String   @db.Uuid
  eventType   String
  message     String?
  createdById String?  @db.Uuid
  createdAt   DateTime @default(now())

  document  Document @relation(fields: [documentId], references: [id])
  createdBy User?    @relation(fields: [createdById], references: [id])

  @@index([documentId])
  @@index([createdById])
}


// =========================
// NEGÓCIOS (FUNIS)
// =========================

model Pipeline {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  stages PipelineStage[]
  deals  Deal[]
}

model PipelineStage {
  id         String  @id @default(uuid()) @db.Uuid
  pipelineId String  @db.Uuid
  name       String
  position   Int
  isWon      Boolean @default(false)
  isLost     Boolean @default(false)
  active     Boolean @default(true)

  pipeline Pipeline @relation(fields: [pipelineId], references: [id])
  deals    Deal[]

  @@index([pipelineId])
}

model Deal {
  id                String   @id @default(uuid()) @db.Uuid
  code              String   @unique
  pipelineId        String   @db.Uuid
  stageId           String   @db.Uuid
  clientId          String   @db.Uuid

  title             String?
  contactName       String?
  contactPhone      String?
  contactEmail      String?

  estimatedValue    Decimal  @default(0) @db.Decimal(12, 2)
  priority          String   @default("MEDIUM") // LOW | MEDIUM | HIGH
  status            String   @default("OPEN")   // OPEN | WON | LOST | CANCELED
  ownerId           String?  @db.Uuid
  source            String?
  expectedCloseDate DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  pipeline Pipeline      @relation(fields: [pipelineId], references: [id])
  stage    PipelineStage @relation(fields: [stageId], references: [id])
  client   Client        @relation(fields: [clientId], references: [id])
  owner    User?         @relation(fields: [ownerId], references: [id])

  activities DealActivity[]
  documents  DealDocument[]

  @@index([pipelineId])
  @@index([stageId])
  @@index([clientId])
  @@index([ownerId])
}

model DealActivity {
  id          String   @id @default(uuid()) @db.Uuid
  dealId      String   @db.Uuid
  type        String
  message     String?
  createdById String?  @db.Uuid
  createdAt   DateTime @default(now())

  deal      Deal  @relation(fields: [dealId], references: [id])
  createdBy User? @relation(fields: [createdById], references: [id])

  @@index([dealId])
  @@index([createdById])
}

model DealDocument {
  id         String   @id @default(uuid()) @db.Uuid
  dealId     String   @db.Uuid
  documentId String   @db.Uuid
  createdAt  DateTime @default(now())

  deal     Deal     @relation(fields: [dealId], references: [id])
  document Document @relation(fields: [documentId], references: [id])

  @@unique([dealId, documentId])
  @@index([documentId])
}


// =========================
// USUÁRIOS / PERFIS / PERMISSÕES
// =========================

model Role {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique // ADMIN, COMERCIAL, FINANCEIRO...
  description String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  users        User[]
  permissions  RolePermission[]
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  username     String   @unique
  fullName     String?
  email        String?  @unique
  phone        String?
  passwordHash String
  roleId       String   @db.Uuid
  status       String   @default("ACTIVE") // ACTIVE | INACTIVE
  lastLoginAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  role Role @relation(fields: [roleId], references: [id])

  createdDocuments   Document[]
  documentEvents     DocumentEvent[]
  dealActivities     DealActivity[]
  ownedDeals         Deal[]
  purchasesRequested Purchase[] @relation("PurchaseRequestedBy")
  purchasesOwned      Purchase[] @relation("PurchaseResponsible")
  purchaseEvents     PurchaseEvent[]
  receipts           PurchaseReceipt[]
  assistances         Assistance[]
  assistanceEvents    AssistanceEvent[]
  vehicleSchedules    VehicleSchedule[]
  serviceOrders       ServiceOrder[]
  vehicles            Vehicle[]
  auditLogs           AuditLog[]
  financialEntries    FinancialEntry[]
  financialEvents     FinancialEvent[]

  @@index([roleId])
}

model Permission {
  id          String  @id @default(uuid()) @db.Uuid
  key         String  @unique
  description String?
  active      Boolean @default(true)

  roles RolePermission[]
}

model RolePermission {
  id           String   @id @default(uuid()) @db.Uuid
  roleId       String   @db.Uuid
  permissionId String   @db.Uuid
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@unique([roleId, permissionId])
  @@index([permissionId])
}


// =========================
// FINANCEIRO
// =========================

model FinancialCategory {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique
  type      String   // RECEIVE | PAY | BOTH
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  entries FinancialEntry[]
}

model FinancialEntry {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique
  type        String   // RECEIVE | PAY
  status      String   @default("OPEN") // OPEN | PAID | OVERDUE | CANCELED
  description String
  categoryId  String?  @db.Uuid

  clientId    String?  @db.Uuid
  supplierId  String?  @db.Uuid
  documentId  String?  @db.Uuid

  dueDate     DateTime
  paymentDate DateTime?

  amount      Decimal  @db.Decimal(12, 2)
  paidAmount  Decimal? @db.Decimal(12, 2)
  interest    Decimal  @default(0) @db.Decimal(12, 2)
  discount    Decimal  @default(0) @db.Decimal(12, 2)

  createdById String?  @db.Uuid
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category  FinancialCategory? @relation(fields: [categoryId], references: [id])
  client    Client?            @relation(fields: [clientId], references: [id])
  supplier  Supplier?          @relation(fields: [supplierId], references: [id])
  document  Document?          @relation(fields: [documentId], references: [id])
  createdBy User?              @relation(fields: [createdById], references: [id])

  events FinancialEvent[]

  @@index([categoryId])
  @@index([clientId])
  @@index([supplierId])
  @@index([documentId])
  @@index([createdById])
}

model FinancialEvent {
  id               String   @id @default(uuid()) @db.Uuid
  financialEntryId String   @db.Uuid
  type             String   // CREATED, PAID, UPDATED, CANCELED
  message          String?
  createdById      String?  @db.Uuid
  createdAt        DateTime @default(now())

  entry     FinancialEntry @relation(fields: [financialEntryId], references: [id])
  createdBy User?          @relation(fields: [createdById], references: [id])

  @@index([financialEntryId])
  @@index([createdById])
}


// =========================
// COMPRAS
// =========================

model Purchase {
  id            String   @id @default(uuid()) @db.Uuid
  code          String   @unique
  supplierId    String?  @db.Uuid
  requestedById String?  @db.Uuid
  responsibleId String?  @db.Uuid
  type          String   @default("REQUEST")   // REQUEST | ORDER
  status        String   @default("REQUESTED") // REQUESTED | QUOTING | ORDERED | RECEIVED | CANCELED
  title         String?
  notes         String?
  estimatedTotal Decimal @default(0) @db.Decimal(12, 2)
  total          Decimal @default(0) @db.Decimal(12, 2)
  requestedAt    DateTime @default(now())
  expectedAt     DateTime?
  receivedAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  supplier     Supplier? @relation(fields: [supplierId], references: [id])
  requestedBy  User?     @relation("PurchaseRequestedBy", fields: [requestedById], references: [id])
  responsible  User?     @relation("PurchaseResponsible", fields: [responsibleId], references: [id])

  items     PurchaseItem[]
  events    PurchaseEvent[]
  receipts  PurchaseReceipt[]

  @@index([supplierId])
  @@index([requestedById])
  @@index([responsibleId])
}

model PurchaseItem {
  id          String   @id @default(uuid()) @db.Uuid
  purchaseId  String   @db.Uuid
  productId   String?  @db.Uuid
  description String?
  quantity    Decimal  @default(1) @db.Decimal(12, 2)
  unitPrice   Decimal  @default(0) @db.Decimal(12, 2)
  total       Decimal  @default(0) @db.Decimal(12, 2)

  purchase Purchase @relation(fields: [purchaseId], references: [id])
  product  Product? @relation(fields: [productId], references: [id])

  receiptItems PurchaseReceiptItem[]

  @@index([purchaseId])
  @@index([productId])
}

model PurchaseEvent {
  id          String   @id @default(uuid()) @db.Uuid
  purchaseId  String   @db.Uuid
  type        String
  message     String?
  createdById String?  @db.Uuid
  createdAt   DateTime @default(now())

  purchase  Purchase @relation(fields: [purchaseId], references: [id])
  createdBy User?     @relation(fields: [createdById], references: [id])

  @@index([purchaseId])
  @@index([createdById])
}

model PurchaseReceipt {
  id          String   @id @default(uuid()) @db.Uuid
  purchaseId  String   @db.Uuid
  receivedById String? @db.Uuid
  receivedAt  DateTime @default(now())
  notes       String?

  purchase   Purchase @relation(fields: [purchaseId], references: [id])
  receivedBy User?    @relation(fields: [receivedById], references: [id])

  items PurchaseReceiptItem[]

  @@index([purchaseId])
  @@index([receivedById])
}

model PurchaseReceiptItem {
  id              String   @id @default(uuid()) @db.Uuid
  receiptId       String   @db.Uuid
  purchaseItemId  String   @db.Uuid
  quantityReceived Decimal @db.Decimal(12, 2)

  receipt      PurchaseReceipt @relation(fields: [receiptId], references: [id])
  purchaseItem PurchaseItem    @relation(fields: [purchaseItemId], references: [id])

  @@index([receiptId])
  @@index([purchaseItemId])
}


// =========================
// ASSISTÊNCIAS
// =========================

model Assistance {
  id            String   @id @default(uuid()) @db.Uuid
  code          String   @unique
  clientId      String   @db.Uuid
  addressId     String?  @db.Uuid
  type          String
  priority      String   @default("MEDIUM")
  stage         String   @default("NEW")
  status        String   @default("OPEN")
  title         String?
  description   String
  responsibleId String?  @db.Uuid
  scheduledAt   DateTime?
  finishedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  client      Client        @relation(fields: [clientId], references: [id])
  address     ClientAddress? @relation(fields: [addressId], references: [id])
  responsible User?         @relation(fields: [responsibleId], references: [id])

  events    AssistanceEvent[]
  files     AssistanceFile[]
  documents AssistanceDocument[]

  @@index([clientId])
  @@index([addressId])
  @@index([responsibleId])
}

model AssistanceEvent {
  id           String   @id @default(uuid()) @db.Uuid
  assistanceId String   @db.Uuid
  type         String
  message      String?
  createdById  String?  @db.Uuid
  createdAt    DateTime @default(now())

  assistance Assistance @relation(fields: [assistanceId], references: [id])
  createdBy  User?      @relation(fields: [createdById], references: [id])

  @@index([assistanceId])
  @@index([createdById])
}

model AssistanceFile {
  id           String   @id @default(uuid()) @db.Uuid
  assistanceId String   @db.Uuid
  fileName     String
  mimeType     String?
  storageKey   String
  sizeBytes    Int?
  createdAt    DateTime @default(now())

  assistance Assistance @relation(fields: [assistanceId], references: [id])

  @@index([assistanceId])
}

model AssistanceDocument {
  id           String   @id @default(uuid()) @db.Uuid
  assistanceId String   @db.Uuid
  documentId   String   @db.Uuid
  createdAt    DateTime @default(now())

  assistance Assistance @relation(fields: [assistanceId], references: [id])
  document   Document   @relation(fields: [documentId], references: [id])

  @@unique([assistanceId, documentId])
  @@index([documentId])
}


// =========================
// FROTA / AGENDA / OS
// =========================

model Vehicle {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  plate     String   @unique
  type      String
  capacity  String?
  status    String   @default("ACTIVE") // ACTIVE | MAINTENANCE | INACTIVE
  driverId  String?  @db.Uuid
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  driver    User?            @relation(fields: [driverId], references: [id])
  schedules VehicleSchedule[]
  serviceOrders ServiceOrder[]

  @@index([driverId])
}

model VehicleSchedule {
  id          String   @id @default(uuid()) @db.Uuid
  vehicleId   String   @db.Uuid
  clientId    String?  @db.Uuid
  addressId   String?  @db.Uuid
  type        String
  title       String?
  description String?
  startAt     DateTime
  endAt       DateTime?
  status      String   @default("SCHEDULED") // SCHEDULED | IN_ROUTE | DONE | CANCELED
  createdById String?  @db.Uuid
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  vehicle   Vehicle        @relation(fields: [vehicleId], references: [id])
  client    Client?        @relation(fields: [clientId], references: [id])
  address   ClientAddress? @relation(fields: [addressId], references: [id])
  createdBy User?          @relation(fields: [createdById], references: [id])

  serviceOrders ServiceOrder[]

  @@index([vehicleId])
  @@index([clientId])
  @@index([addressId])
  @@index([createdById])
}

model ServiceOrder {
  id         String   @id @default(uuid()) @db.Uuid
  code       String   @unique
  vehicleId  String   @db.Uuid
  scheduleId String?  @db.Uuid
  date       DateTime
  driverId   String?  @db.Uuid
  status     String   @default("OPEN") // OPEN | IN_PROGRESS | DONE | CANCELED
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  vehicle  Vehicle         @relation(fields: [vehicleId], references: [id])
  schedule VehicleSchedule? @relation(fields: [scheduleId], references: [id])
  driver   User?           @relation(fields: [driverId], references: [id])

  items ServiceOrderItem[]

  @@index([vehicleId])
  @@index([scheduleId])
  @@index([driverId])
}

model ServiceOrderItem {
  id             String  @id @default(uuid()) @db.Uuid
  serviceOrderId String  @db.Uuid
  clientId       String? @db.Uuid
  addressId      String? @db.Uuid
  sequence       Int
  description    String?
  status         String  @default("PENDING") // PENDING | DONE | FAILED

  serviceOrder ServiceOrder  @relation(fields: [serviceOrderId], references: [id])
  client       Client?       @relation(fields: [clientId], references: [id])
  address      ClientAddress? @relation(fields: [addressId], references: [id])

  @@index([serviceOrderId])
  @@index([clientId])
  @@index([addressId])
}


// =========================
// LOG / AUDITORIA
// =========================

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String?  @db.Uuid
  entityType String
  entityId   String?  @db.Uuid
  action     String
  message    String?
  metadata   Json?
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([entityId])
}
